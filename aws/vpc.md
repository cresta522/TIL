# VPC (基礎)

リージョン：国

AZ(アベイラビリティーゾーン)：データセンター

VPCはリージョンを跨ぐことはできない。

VPCに複数のAZを使用することは可能。

複数AZを使用することにより、片方のAZで障害が発生したり、ELBでの生存確認ができなかった場合自動的に切り替わる。


## IPアドレス

サブネットは /24 が定石。

AZのなかでサブネット分割されたIPを振り分けることが可能だが、AZを跨ぐことは出来ない。

/24とすることで、第4オクテットを自由に使うことが可能となる。256のIPが振り分けられ、十分な数が確保できる。
また、第4オクテットで分割することによって
- subnet1 : 10.1.**1**.0-10.1.**1**.255
- subnet2 : 10.1.**2**.0-10.1.**2**.255
と管理がしやすくなる。

/28など、あまりに分割単位を小さくしてしまうとELB(ロードバランサー)が使用できなくなる。

最初の4IPと最後の1IPはAWSが予約しているため、使用不可。

# VPC (構成)

Region の中に VPC を設置 (CIDR 10.1.0.0/16)

VPCの中に AZ(Avaliability Zone, データセンター)1, AZ2を設置

AZ1の中に Public subnet, Private subnet

AZ2の中に Public subnet, Private subnet

とできる。このPublic Subnetはインターネットと通信できるサブネットであり、DMZやInternet Facingとも呼ばれる

また、インターネットなどの外部ネットワークを**Untrusted**(信頼できない)、内部ネットワークを**Trusted**(信頼できる)と呼ぶことがある。
この表記はF/Wを隔ててどちら側のネットワークかを示す際に用いられる。

このVPCは /16 で分割しているため、10.1.**0.0**と第3オクテットと第4オクテットが自由に使える

VPCのアドレスレンジ帯はRFC1918で制定されており、

- クラスA : 10.**0.0.0** - 10.255.255.255 (10 /8 prefix)
- クラスB : 172.**16.0.0** - 172.31.255.255 (172.16 /12 prefix)
- クラスC : 192.168.**0.0** - 192.168.255.255 (192.168 /16 prefix)

とネットワークの規模で分割方法を考える。

VPCは /16 で切り分けたが 上述の通りサブネットは /24 が定石。ここでは、

- AZ1 Public Subnet : 10.1.**0**.0/24
- AZ2 Public Subnet : 10.1.**1**.0/24
- AZ1 Private Subnet : 10.1.**2**.0/24
- AZ2 Private Subnet : 10.1.**3**.0/24

と設定。

## ルートテーブル

ここで、各サブネットにEC2インスタンスを1台ずつ設置したと仮定。

AZ1 Public Subnet が AZ2 Public Subnet に通信をしたい場合、**ルートテーブル**を設定する必要がある。

ルートテーブルは、サブネットに関連付けて設定するもので、サブネットから外に出る通信をどこに向けて発信するかを決めるルール。

AZ1 Public Subnet のルートテーブルは

|  Destination  |  Target  |
| ---- | ---- |
|  10.1.0.0/16  |  Local  |

10.1.0.0/16の範囲であればVPC内部に通信が届くという意味になる。

- サブネットはルートテーブルを最低でも一つ設定しなければならない
- デフォルトからあるルートテーブルは**メインルートテーブル**と呼ぶ。
- メインルートテーブルの使用は控える。
    - 何事も、既定のものは攻撃対象になりやすいので控えるのが定石
    - メインルートテーブルを変更すると、予期せぬ通信を行ってしまうことが考えられるため
- ルートテーブルは最も明確なルールが優先して適用される。以下のルートの場合はRouteAに向けたルーティングの方が厳密なIPまで指定できているため優先される。
    |  Destination  |  Target  |
    | ---- | ---- |
    |  10.1.0.0/16  |  Local  |
    |  10.1.3.96/32  |  RouteA  |

# VPC (IGW,EIP,SCグループ,NW ACL)

## IGW

- 初期設定のままではVPCはインターネットにつなぐことが出来ない。インターネットに繋ぐ方法は、**IGW**(インターネットゲートウェイ)というコンポーネントをアタッチする。アタッチすることで、EC2インスタンスはインターネットに接続することができる。

- ルートテーブルで、IGWに向けた設定を以下の通り行うことで、Localに向けたもの以外はIGWに向くことになる。 0.0.0.0/0はワイルドカードのような意味合いで、すべての通信を指す。

    |  Destination  |  Target  |
    | ---- | ---- |
    |  10.1.0.0/16  |  Local  |
    |  0.0.0.0/0  |  IGW  |

- 基本的にPublic SubnetのデフォルトゲートウェイはIGWである。

## EIP

IGWを経由してVPCがインターネットへつなぐためには外部向けのIPアドレスが必要となってくる。そのIPは2種類ある。

- Public IP
    - AWSのIPアドレスプールより割り当てられる、インターネットと通信することができるIPアドレス
    - 再起動したり終了したりするとこのIPアドレスは開放される。
- Elastic IP
    - インスタンスにアタッチ/デタッチが可能で、静的なインターネットと通信できるIPアドレス
    - インスタンスが再起動、停止、終了した場合も同じIPアドレス
    - 基本無料だが、どこにもアタッチされていない場合は課金される

- VPC内は、プライベートIPしか認識されない。
    - パブリックIPはVPCでは使用できないということ。
    - IGWがNAT変換機能を持つため、プライベートIPとパブリックIPの入れ替えができる。

## セキュリティグループ

- インスタンスがインターネットと通信する際にはセキュリティグループとネットワークACLの設定が必要。

- SCグループはEC2単位で設定がされる仮想F/W。

- 拒否ルールを設定できず、許可ルールを設定していく。
    - 許可ルールは累積的に設定されていく。以下のように設定すると、すべてのポート22の通信が許可される。

    |  Port  |  IP  |
    | ---- | ---- |
    |  22  |  10.0.0.1  |
    |  22  |  ALL  |

- サブネット単位の設定ではないため、同一サブネットに所属するEC2インスタンスでも別のSCグループをアタッチできる。

## ネットワークACL

- サブネット単位で設定されるF/W。SCグループとは異なり、EC2単位ではない。
- サブネットは一つのACLしか持つことができない。
- ルールに番号が付けられ、番号の小さい順から評価されていき、マッチしたらその番号以降の評価はされない。

# VPC (Private Subnetをインターネットに繋ぐには)

## NAT GW

- Private Subnetは個人情報などインターネットに繋ぎたくない場合に用いられる。
    - 他のAWSとつないだり、ソフトウェアのアップデートなどを行いたい場合はある。
    - (セキュリティを保持したままインターネットに接続したいケースがある)

- そういった場合はNAT ゲートウェイが用いられる
    - NAT GW をPublic Subnetに配置し、Private Subnetのルートテーブルを以下のように設定すれば通信が可能。

    |  Destination  |  Target  |
    | ---- | ---- |
    |  10.1.0.0/16  |  Local  |
    |  0.0.0.0/0  |  NAT-GW  |

    - この場合、インスタンスからインターネットに接続することはできても、インターネットからインスタンスへの通信はできない。(セキュリティの確保)

- NAT GW には自動的に**ENI**(Elastic Network Interface)がアタッチされている。
    - このENIにPrivate IPが割り当てられ、NAT GW作成時にElastic IPがアタッチしなければ使用できない。

- ENIとはIPアドレスを割り当ててEC2インスタンスやNAT GWにアタッチして使用するもの。
    - VPC内の仮想NICサービス
    - EC2インスタンスのIPアドレスの正体はENI
    - デフォルトではeth0にENIがアタッチされている
    - 一つのEC2インスタンスに複数のENIをアタッチしてIPを増やすことも可能
    - SCグループをそれぞれのENIに設定することもできる。

## サービス

- 一部AWSサービスにはVPCとリージョンの間に存在するものがあり、**リージョンサービス**と呼ぶ。
    - このサービスに接続するためにはインターネットへの接続が必須。

- リージョンサービスは以下
    - S3, DynamoDB, Lambda, SQS, SNS, IoT

- リージョンサービスと異なり、リージョンの外に存在するサービスは**グローバルサービス**と呼ばれる。
    - IAM, Route53 が該当

# VPC (VPCエンドポイント)

- **VPCエンドポイント**は、VPCからs3などへの通信をプライベートに行うためのサービス

- Untrustedな環境につなぐのはリスキーで、リージョンサービスへはプライベートIPを用いて通信ができる。
    - VPCエンドポイントを用いる。
    - 以下のようにVPCEへのルーティングを設定することでPrivate SubnetもPublic SubnetもEndPointへつなげる。

    |  Destination  |  Target  |
    | ---- | ---- |
    |  10.1.0.0/16  |  Local  |
    |  0.0.0.0/0  |  NAT-GW  |
    |  S3.prefix.list  |  VPCE-123  |

    - VPCEを経由することで、インターネットを経由せずにプライベートな通信を行うことができる。
        - VPCEを用いないとインターネットの通信が必要となる。

- VPCEにはGateway型とInterface型が存在する。
    - Gateway型はS3, DynamoDBのみサポートできて、上記のようにルートテーブルに設定され、安価。
    - Interface型は対象サービスは多いものの課金が高い。
        - 実態はENIで、SCグループをアタッチして使用する。

- VPCEを用いて各サービスに接続することを**Private Link**と呼ぶことがある。
    - これを用いることで、リージョン内の別VPCへの接続がセキュアに可能である。

# VPC (Direct Connect, VPC ピアリング)
## Direct Connect
- オンプレ環境とつなぐ際などに用いられる専用線のこと。
- 企業向けで、通信の帯域保証、セキュアであることが挙げられている。

## VPC Peering
- 別のVPCとの接続を行うサービス。
- ピアリングを開始するには、相手の所有者に接続リクエストを送る必要がある。

# VPC Flow Logs
- VPC接続のログがCloudWatchに溜まってくサービス