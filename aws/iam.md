# IAM
## 概要 IAM(Identify Access Management)

## IAM ユーザー
- アカウントを作成すると、**ルートユーザ**が作成される。
    - 認証情報としてメールアドレスとパスワードを持っている。
    - 全権限を保持
    - 請求情報閲覧可能
    - パスワードの変更可能
    - **日々の業務では使用しないこと**
    - 通常はルートユーザーでなく、IAMユーザを作成する
- ユーザ作成時には認証する情報を選択する必要がある。
    1. パスワードによるコンソールへのアクセス
    1. プログラムからリソースに対するアクセス
    1. 上記両方
- パスワードはマネジメントコンソールへのログインに必要なパスワード
- アクセスキーはアクセスキーIDとシークレットアクセスキーの組み合わせの認証
    - AWS CLIコマンドで設定して そのユーザの認証情報を利用できるもの

- ユーザと言っても、個人を指すユーザとアプリケーション単位を指すユーザの2種類が存在する
    - ログインする際にユーザとしてログインするのか、アプリとしてログインするのかという分け方
## IAM グループ
- IAMユーザをひとまとめにしたもの。権限管理に便利
- IAMグループは正式な認証情報としてAWSでは取り扱われない
- あくまで複数のユーザに一度に権限を付与できる便利な方法としての位置づけ
- ユーザは複数のグループに所属できる。
    - グループ内にグループを持つことはできない。
- デフォルトでグループはないため、必要なら１から作る必要がある

## IAM ロール
- 直訳すると 役割, 任務, 役目
- AWSアカウント内で作成できる認証情報
    - 特定の操作の許可情報を持つ。
    - IAMユーザのように個別に紐付いた認証情報でなく必要なときに使用されるもの
- 短期的な認証情報
- アクセスキーのような情報を持たない

- e.g. ユーザには普段EC2を作成できないようにし、必要なときにのみロールとして削除権限を与える
- e.g. EC2インスタンスなどのAWSサービスに対しても必要なときにのみS3への書き込み権限を与える

- ロールには2種類の側面からの定義がある。
    - **Trust**ポリシー: だれがこのロールを使えるようになるか
    - **Permissions**: どのような操作を行えるようになるか

- 闇雲にフル権限を与えずに適切に権限を割り当てること

## MFA (Multi-Factor Authentication: 他要素認証)
- スマホなどの他のデバイスを用いての認証のことを指す
    - 6桁のOTPを発行することによってより強固になる
- 通常、無料である**仮想MFAデバイス**というスマホアプリを使うのが一般的
- 他、物理的なデバイスを購入することも可能。
- SMSを使用することも可能だが、廃止予定。


## IAMポリシー
### 概要
- ポリシーとはjson形式のドキュメントを指す
- IAMユーザやロールにアタッチして使用するもの
- ポリシーがAWSリソースに対する許可や拒否を定める
- IAMユーザやロールなどの認証される主体のことを**Principal**(プリンシパル)という
    - IAMグループは Principal としては認められていない
    - IAMグループはあくまでグルーピングするもので、認証の対象ではない
- PrincipalからAWSへのリクエストに対して、json(ポリシー)と突き合わせて権限があるか評価する。
- Principalは 認証 が行われる。
    - ルートユーザならメールアドレスとパスワード
    - IAMユーザならアカウントID, ユーザID, パスワード
    - AWS CLIはアクセスキーとシークレットキー
    - 一部 S3など画像の参照などは認証無しで行われる。
- 認証が終わればリクエストフェーズにはいる
    - 認証情報をAWSに対してリクエストを送る
    - リクエストには Actions Or Operations が用いられる
        - Actions Or Operations: Principalが行いたい動作のこと
        - Resources: 操作を行いたい対象
        - Environment Data: IPアドレスやリクエスト日時
        - Resources Data: EC2のタグなどAWSResources特定情報
        - これらに加えてPrincipalが**リクエスト**と言われる
    - Actions Or Operations が ポリシーと結び付けられる

### 6つのポリシー
- リクエストフェーズの次は認可(Authorization)
    - リクエストをもとに許可するか、拒否するかを決めるのが認可
    - ポリシーは大きく6つに分かれる
        1. Identity-based Policies(アイデンティティベースのポリシー)
            - Identity: Principalのこと
            - Principalがどの操作が実行可能か どのリソースにどの条件で？をコントロールする
            - 管理ポリシー
                - AWS管理ポリシー: AWSが予め用意しているポリシー。初心者用
                - カスタマー管理ポリシー: 詳細に設定できるポリシー。直接json記述可能。現在非推奨。

            - インラインポリシー
        1. Resources-based Policies(リソースベースのポリシー)
            - S3など リソースに対するポリシー
        1. Service Control Policies(SCPs)
            - 組織を管理するポリシー
            - AWS Organization: AWSアカウントを作成,管理できるサービス
                - このサービスで管理しているアカウントのポリシーを管理
        1. IAM Permissions Boundaries
            - Principalに付与するポリシー
            - 権限の範囲を狭める
            - Identity-base PoliciesとPermissions Boundariesの両方が許可したものが操作できる
        1. Access Control Policies(ACLs)
            - 他のアカウントのPrincipalがどのリソースにアクセスできるかコントロールできる
            - Resources-basedに似ているが、自身のアカウント制御はできない。
        1. Session Policies
            - IAMユーザの一時的な認証情報をパラメータとして渡すもの

### クロスアカウント
- IAMロールを使用して、自身のAWSアカウントと第三者との間に信頼関係を築くこと
- e.g. 開発アカウントが本番環境アカウントに、本番環境アカウントと同等のロールをリクエストする
    - 許可されれば、開発アカウントが本番環境アカウントのロールのリソースにアクセスができる。

### AWSが権限を評価する流れ
1. Service Control Policies(SCPs)
1. Resources-based Policies
1. IAM Permissions Boundaries
1. Session Policies
1. Identity-based Policies

- 全てに通過すればリクエストが通るながれ。
